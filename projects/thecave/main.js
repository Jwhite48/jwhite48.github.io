import{Map}from"./map.js";import{Player}from"./player.js";import{Wolf,Bear,Snake,Boss}from"./monster.js";import{Claw,Pelt,Scale}from"./item.js";export function main(e){const t=document.getElementById("MapCanvas"),n=t.getContext("2d"),a=new Map(48),o=new Player(e),i=document.getElementById("InfoBox");let d,l=function(e){return new Promise(t=>setTimeout(t,e))},r=function(){return new Promise(e=>d=e)},s=!1,m=!1;document.getElementById("AttackButton").addEventListener("click",async()=>{d&&(d(),s=!0)}),document.getElementById("FleeButton").addEventListener("click",()=>{d&&(d(),m=!0)});let u=!1,c=e=>{"ArrowUp"!=e.key||u?"ArrowDown"!=e.key||u?"ArrowRight"!=e.key||u?"ArrowLeft"!=e.key||u||a.playerMovement(4,o)&&(u=!0,L()):a.playerMovement(3,o)&&(u=!0,L()):a.playerMovement(2,o)&&(u=!0,L()):a.playerMovement(1,o)&&(u=!0,L())},y=e=>{"ArrowUp"!=e.key&&"ArrowDown"!=e.key&&"ArrowRight"!=e.key&&"ArrowLeft"!=e.key||(u=!1),"Inn"==a.currentTile?document.getElementById("EnterInnButton").style.display="flex":"Cave"==a.currentTile?document.getElementById("EnterCaveButton").style.display="flex":(document.getElementById("EnterInnButton").style.display="none",document.getElementById("EnterCaveButton").style.display="none")};document.addEventListener("keydown",c),document.addEventListener("keyup",y);let w=!1;document.getElementById("EnterInnButton").addEventListener("click",async()=>{document.removeEventListener("keydown",c),document.removeEventListener("keyup",y),w=!0,o.heal(),await l(1250),w=!1,document.addEventListener("keydown",c),document.addEventListener("keyup",y)});let g=!1;document.getElementById("EnterCaveButton").addEventListener("click",()=>{document.removeEventListener("keydown",c),document.removeEventListener("keyup",y),document.getElementById("GameButtons").style.display="none",g=!0,f(new Boss)});let B=!1;document.getElementById("InventoryButton").addEventListener("click",()=>{document.removeEventListener("keydown",c),document.removeEventListener("keyup",y),document.getElementById("GameButtons").style.display="none",document.getElementById("BackButtonDiv").style.display="flex",document.getElementById("CraftableButtons").style.display="flex",document.getElementById("RemoveItemsDiv").style.display="flex",B=!0}),document.getElementById("CraftSwordButton").addEventListener("click",()=>{o.noSword&&o.craftable({claws:2,pelts:1,scales:0})}),document.getElementById("CraftShieldButton").addEventListener("click",()=>{o.noShield&&o.craftable({claws:0,pelts:1,scales:2})}),document.getElementById("CraftBoatButton").addEventListener("click",()=>{o.noBoat&&o.craftable({claws:0,pelts:3,scales:0})});let h=!1;document.getElementById("PlayerStatusButton").addEventListener("click",()=>{document.removeEventListener("keydown",c),document.removeEventListener("keyup",y),document.getElementById("GameButtons").style.display="none",document.getElementById("BackButtonDiv").style.display="flex",h=!0}),document.getElementById("BackButton").addEventListener("click",()=>{document.addEventListener("keydown",c),document.addEventListener("keyup",y),document.getElementById("CraftableButtons").style.display="none",document.getElementById("BackButtonDiv").style.display="none",document.getElementById("RemoveItemsDiv").style.display="none",document.getElementById("GameButtons").style.display="flex",B=!1,h=!1}),document.getElementById("RemoveClawButton").addEventListener("click",()=>{o.removeInventory("Claw")}),document.getElementById("RemovePeltButton").addEventListener("click",()=>{o.removeInventory("Pelt")}),document.getElementById("RemoveScaleButton").addEventListener("click",()=>{o.removeInventory("Scale")});let v=!1,k=!1;document.getElementById("BossAttackButton").addEventListener("click",async()=>{d&&(d(),v=!0)}),document.getElementById("BossDefendButton").addEventListener("click",()=>{d&&(d(),k=!0)});let E=!1,p=async function(e){document.removeEventListener("keydown",c),document.removeEventListener("keyup",y),document.getElementById("GameButtons").style.display="none";let t=!1;for(;;){if(i.innerHTML=`The wild ${e.name} attacks!`,await l(750),i.innerHTML+=`\nThe ${e.name} does ${o.takeDamage(e.fight())} damage!`,await l(750),o.isDead())return i.innerHTML+="\nYOU DIED!",await l(1500),document.getElementById("Game").style.display="none",void(document.getElementById("GameOverScreen").style.display="block");if(i.innerHTML+=`\nYou're at ${o.hp} HP. What do you do?`,document.getElementById("BattleButtons").style.display="flex",await r(),document.getElementById("BattleButtons").style.display="none",s){if(s=!1,i.innerHTML="You attack!",await l(750),i.innerHTML+=`\nThe ${e.name} takes ${e.takeDamage(o.fight())} damage!`,await l(750),e.isDead()){i.innerHTML+=`\nYou have bested the ${e.name}!`,await l(750),i.innerHTML+=`\nYou gained ${e.exp} exp!`,await l(750),o.gainExp(e.exp)&&(i.innerHTML+=`\nYou leveled up to LV ${o.lvl}!`,await l(1250));break}i.innerHTML+=`\nThe ${e.name} has ${e.hp} HP left!`,await l(1250)}else if(m){m=!1;let n=Math.floor(10*Math.random());if(9-(e.spd-o.spd)>n){t=!0,i.innerHTML="You succesfully ran away!",await l(1250);break}i.innerHTML="You couldn't run away!",await l(1250)}}if(!t){t=!1;let n=Math.floor(10*Math.random());switch(e.name){case"Wolf":n<=4&&o.addInventory(new Claw)&&(i.innerHTML+=`\nThe ${e.name} dropped a claw!`,await l(1250));break;case"Bear":n<=2&&o.addInventory(new Pelt)&&(i.innerHTML+=`\nThe ${e.name} dropped a pelt!`,await l(1250));break;case"Snake":n<=2&&o.addInventory(new Scale)&&(i.innerHTML+=`\nThe ${e.name} dropped a scale!`,await l(1250))}}E=!1,document.addEventListener("keydown",c),document.addEventListener("keyup",y),document.getElementById("GameButtons").style.display="flex"},L=async function(){let e=Math.floor(10*Math.random());if("Forest"==a.currentTile&&e<=1){E=!0,u=!1,Math.floor(10*Math.random())<=6?await p(new Wolf):await p(new Bear)}else"Desert"==a.currentTile&&e<=1&&(E=!0,u=!1,await p(new Snake))},f=async function(e){i.innerHTML="You wander through the pitch black cave, running your hands on the nearby wall for support.",await l(2500),i.innerHTML+="\nSuddenly...",await l(1e3),i.innerHTML+="\nBOOM: A giant pillar of light erupts in front of you, revealing a floating mask. It flashes a wicked smile...",await l(3e3);let t=!1,n=!1;for(;;){if(t=!1,i.innerHTML+=`\nYou're at ${o.hp} HP. What do you do?`,document.getElementById("BossButtons").style.display="flex",await r(),document.getElementById("BossButtons").style.display="none",v){if(v=!1,i.innerHTML="You attack!",await l(750),i.innerHTML+=`\nThe Floating Mask takes ${e.takeDamage(o.fight())} damage!`,await l(750),e.isDead())return i.innerHTML+="\nWith one last blow, The Floating Mask crumbles to the floor, revealing a bright light behind it.",await l(3e3),i.innerHTML+="\nYou walk towards it...and emerge on a remote island. Your once ravaged ship has been rebuilt. You can now go home!",await l(3e3),i.innerHTML+="\n\n\nCreated By: Jesse White",await l(5e3),document.getElementById("Game").style.display="none",void(document.getElementById("WinnerScreen").style.display="block");i.innerHTML+=`\nThe Floating Mask has ${e.hp} HP left!`,await l(1250)}else k&&(k=!1,o.noShield?(i.innerHTML="You have nothing to defend with, but nevertheless, brace for the upcoming attack!",await l(2e3)):(t=!0,i.innerHTML="You raise your shield and brace for the upcoming attack!",await l(2e3)));if(n){if(n=!1,i.innerHTML="The Floating Mask unleashes a beam of energy!",await l(1500),t){if(i.innerHTML+="\nYou deflect the beam back at The Floating Mask with the shield!",await l(1250),i.innerHTML+=`\nThe Floating Mask takes ${e.takeDamage(75)} damage!`,await l(1250),e.isDead())return i.innerHTML="With one last blow, The Floating Mask crumbles to the floor, revealing a bright light behind it.",await l(3e3),i.innerHTML+="\nYou walk towards it...and emerge on a remote island. Your once ravaged ship has been rebuilt. You can now go home!",await l(3e3),i.innerHTML+="\n\n\nCreated By: Jesse White",await l(5e3),document.getElementById("Game").style.display="none",void(document.getElementById("WinnerScreen").style.display="block");i.innerHTML+=`\nThe Floating Mask has ${e.hp} HP left!`,await l(1250);continue}if(i.innerHTML+=`\nThe Floating Mask does ${o.takeDamage(75)} damage!`,await l(1250),o.isDead())return i.innerHTML+="\nYOU DIED!",await l(3e3),document.getElementById("Game").style.display="none",void(document.getElementById("GameOverScreen").style.display="block")}else if(Math.floor(100*Math.random())<=29&&!n?(n=!0,i.innerHTML="The Floating Mask is charging up",await l(500),i.innerHTML+=".",await l(500),i.innerHTML+=".",await l(500),i.innerHTML+=".",await l(500),await l(1e3)):(i.innerHTML="The Floating Mask grins and attacks!",await l(750),i.innerHTML+=`\nThe Floating Mask does ${o.takeDamage(e.fight())} damage!`,await l(750)),o.isDead())return i.innerHTML+="\nYOU DIED!",await l(3e3),document.getElementById("Game").style.display="none",void(document.getElementById("GameOverScreen").style.display="block")}};setInterval(function(){a.draw(t,n),B?i.innerHTML=o.displayInventory():h?i.innerHTML=o.status():g?i.innerHTML+="":w?i.innerHTML="You have been healed to full health!":E||(i.innerHTML=`Current Tile: ${a.currentTile}\n            Use the arrow keys to move around.`)},1e3/60)};